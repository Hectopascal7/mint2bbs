<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>薄荷社区-发帖</title>
    <link rel="icon" href="/image/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="fly,layui,前端社区">
    <meta name="description"
          content="Fly社区是模块化前端UI框架Layui的官网社区，致力于为web开发提供强劲动力">
    <link rel="stylesheet" href="/script/layui/css/layui.css">
    <link rel="stylesheet" href="/css/global.css">
    <script src="/script/jquery-3.3.1.min.js"></script>
</head>
<body>

<div class="fly-header layui-bg-black">
    <div class="layui-container">
        <a class="fly-logo" href="/">
            <img src="../../../image/logo.png" alt="layui">
        </a>
        <ul class="layui-nav fly-nav layui-hide-xs">
            <li class="layui-nav-item layui-this">
                <a href="/">
                    <i class="iconfont icon-jiaoliu"></i>业主论坛
                </a>
            </li>
            <li class="layui-nav-item">
                <a href="/page/portal/market/market.html">
                    <i class="iconfont icon-iconmingxinganli"></i>交易市场
                </a>
            </li>
            <li class="layui-nav-item">
                <a href="http://www.layui.com/" target="_blank">
                    <i class="iconfont icon-ui"></i>吐槽区
                </a>
            </li>
        </ul>
        <ul class="layui-nav fly-nav-user">
            <!-- 登入后的状态 -->
            <li class="layui-nav-item">
                <a class="fly-nav-avatar" href="javascript:;" id="center"></a>
                <dl class="layui-nav-child">
                    <dd>
                        <a href="../user/setting.html"><i class="layui-icon">
                            &#xe620;</i>基本设置
                        </a>
                    </dd>
                    <dd>
                        <a href="../user/message.html">
                            <i class="iconfont icon-tongzhi" style="top: 4px;"></i>我的消息
                        </a>
                    </dd>
                    <dd>
                        <a href="../user/home.html">
                            <i class="layui-icon" style="margin-left: 2px; font-size: 22px;">&#xe68e;</i>我的主页
                        </a>
                    </dd>
                    <hr style="margin: 5px 0;">
                    <dd>
                        <a href="" style="text-align: center;">退出</a>
                    </dd>
                </dl>
            </li>
        </ul>
    </div>
</div>

<div class="layui-container fly-marginTop">
    <div class="fly-panel" pad20 style="padding-top: 5px;">
        <!--<div class="fly-none">没有权限</div>-->
        <div class="layui-form layui-form-pane">
            <div class="layui-tab layui-tab-brief" lay-filter="user">
                <ul class="layui-tab-title">
                    <li class="layui-this">发表帖子</li>
                </ul>
                <div class="layui-form layui-tab-content" id="LAY_ucm" style="padding: 20px 0;">
                    <div class="layui-tab-item layui-show">
                        <form method="post">
                            <div class="layui-row layui-col-space15 layui-form-item">
                                <div class="layui-col-md3">
                                    <label class="layui-form-label">发帖板块</label>
                                    <div class="layui-input-block" id="section"></div>
                                </div>
                                <div class="layui-col-md9">
                                    <label for="L_title" class="layui-form-label">标题</label>
                                    <div class="layui-input-block">
                                        <input type="text" id="L_title" name="title" required lay-verify="required"
                                               autocomplete="off" class="layui-input">
                                        <!--<input type="hidden" name="id" value="{{d.edit.id}}"> -->
                                    </div>
                                </div>
                            </div>

                            <!--商品发布选项，后期改造为商品发布页面可能会用到-->
                            <!--<div class="layui-row layui-col-space15 layui-form-item layui-hide" id="LAY_quiz">-->
                            <!--<div class="layui-col-md3">-->
                            <!--<label class="layui-form-label">新旧程度</label>-->
                            <!--<div class="layui-input-block">-->
                            <!--<select name="project">-->
                            <!--<option></option>-->
                            <!--<option value="layui">9成新</option>-->
                            <!--<option value="独立版layer">8成新</option>-->
                            <!--<option value="独立版layDate">6成新</option>-->
                            <!--<option value="LayIM">5成新</option>-->
                            <!--<option value="Fly社区模板">5成以下</option>-->
                            <!--</select>-->
                            <!--</div>-->
                            <!--</div>-->
                            <!--<div class="layui-col-md3">-->
                            <!--<label class="layui-form-label" for="L_version">理想价格</label>-->
                            <!--<div class="layui-input-block">-->
                            <!--<input type="text" id="L_version" value="" name="version" autocomplete="off"-->
                            <!--class="layui-input">-->
                            <!--</div>-->
                            <!--</div>-->
                            <!--<div class="layui-col-md6">-->
                            <!--<label class="layui-form-label" for="L_browser">浏览器</label>-->
                            <!--<div class="layui-input-block">-->
                            <!--<input type="text" id="L_browser" value="" name="browser"-->
                            <!--placeholder="浏览器名称及版本，如：IE 11" autocomplete="off" class="layui-input">-->
                            <!--</div>-->
                            <!--</div>-->
                            <!--</div>-->

                            <div class="layui-form-item layui-form-text">
                                <div class="layui-input-block">
                                    <textarea id="content" name="content" required lay-verify="required"
                                              placeholder="" class="layui-textarea fly-editor"
                                              style="height: 260px;"></textarea>
                                </div>
                            </div>
                            <!--<div class="layui-form-item">-->
                            <!--<div class="layui-inline">-->
                            <!--<label class="layui-form-label">悬赏飞吻</label>-->
                            <!--<div class="layui-input-inline" style="width: 190px;">-->
                            <!--<select name="experience">-->
                            <!--<option value="20">20</option>-->
                            <!--<option value="30">30</option>-->
                            <!--<option value="50">50</option>-->
                            <!--<option value="60">60</option>-->
                            <!--<option value="80">80</option>-->
                            <!--</select>-->
                            <!--</div>-->
                            <!--<div class="layui-form-mid layui-word-aux">发表后无法更改飞吻</div>-->
                            <!--</div>-->
                            <!--</div>-->
                            <!--<div class="layui-form-item">-->
                            <!--<label for="L_vercode" class="layui-form-label">验证码</label>-->
                            <!--<div class="layui-input-inline">-->
                            <!--<input type="text" id="L_vercode" name="vercode" required lay-verify="required"-->
                            <!--placeholder="请回答后面的问题" autocomplete="off" class="layui-input">-->
                            <!--</div>-->
                            <!--<div class="layui-form-mid">-->
                            <!--<span style="color: #c00;">1+1=?</span>-->
                            <!--</div>-->
                            <!--</div>-->
                            <div class="layui-form-item">
                                <button class="layui-btn" lay-filter="*" lay-submit>
                                    立即发布
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="fly-footer">
    <p>
        <a href="http://fly.layui.com/" target="_blank">薄荷社区</a> 2019 &copy;
        <a href="http://www.layui.com/" target="_blank">橙色薄荷° 出品</a>
    </p>
    <p>
        <a href="http://fly.layui.com/jie/3147/" target="_blank">
            Copyright &copy; 2019 橙色薄荷° All Rights Reserved.
        </a>
    </p>
</div>

<script src="/script/layui/layui.js"></script>
<script>

    layui.cache.page = 'jie';

    layui.cache.user = {
        username: '游客'
        , uid: -1
        , avatar: '/image/avatar/00.jpg'
        , experience: 83
        , sex: '男'
    };
    layui.config({
        version: "3.0.0"
        , base: '/script/mods/'
    }).extend({
        fly: 'index'
    }).use('fly');

    // 通过地址栏获取用户是在哪个板块发起的发表帖子功能
    // section——板块唯一标识，通过url?section=xxx传递过来
    var section = GetQueryString("section");

    // 通过地址栏获取当前板块唯一标识
    function GetQueryString(section) {
        var reg = new RegExp("(^|&)" + section + "=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) return unescape(r[2]);
        return null;
    }

    // 表单提交
    layui.use(['form', 'layer'], function () {
        var form = layui.form;
        var layer = layui.layer;
        //监听提交
        form.on('submit(*)', function (data) {
            alert(data.field.sid);
            section = data.field.sid;
            $.ajax({
                type: 'post',
                url: '/post/post.do',
                dataType: 'json',
                data: data.field,
                async: false,
                success: function (data) {
                    layer.alert(data.msg, function () {
                        // 发帖成功，返回对应板块
                        location.href = "/page/portal/section/section.html?section=" + section;
                    });
                },
                error: function (data) {
                    layer.alert(data.msg);
                }
            })
            return false;
        });
    });

</script>

<!--发帖所在板块模板 -->
<script type="text/html" id="m_section">
    <select lay-verify="required" name="sid" lay-filter="column">
        <option></option>
        {{# layui.each(d, function(index, item){ }}
        {{# if(item.sname==='首页'){ }}
        {{#} else if(item.sid===section){ }}
        <option value="{{item.sid}}" selected="">{{item.sname}}</option>
        {{#} else { }}
        <option value="{{item.sid}}">{{item.sname}}</option>
        {{# } }}
        {{# }); }}
    </select>
</script>

<!--用户中心模板-->
<script id="m_center" type="text/html">
    <cite class="layui-hide-xs">{{ d.nickname }}</cite>
    {{#  if(d.role === 1){ }}
    <i class="iconfont icon-renzheng layui-hide-xs" title="认证信息：管理员"></i>
    <i class="layui-badge fly-badge-vip layui-hide-xs" title="积分 {{d.point}}">Lv.3</i>
    {{#  } }}
    <img src="{{ d.profile }}">
</script>

<script>

    var section_list;
    $.ajax({
        type: 'post',
        url: '/section/getSection.do',
        dataType: 'json',
        async: false,
        success: function (data) {
            section_list = data.data;
        },
        error: function (data) {
            layer.msg("获取板块信息失败！");
        }
    })

    var user_info;
    $.ajax({
        type: 'post',
        url: '/user/userCenter.do',
        data: {},
        dataType: 'json',
        async: false,
        success: function (data) {
            user_info = data.data;
        },
        error: function (data) {
            alert("获取用户信息失败！");
        }
    })

    layui.use('laytpl', function () {
        laytpl = layui.laytpl;

        // 板块列表渲染
        var section_model = document.getElementById('m_section').innerHTML;
        var section_view = document.getElementById('section');
        laytpl(section_model).render(section_list, function (html) {
            section_view.innerHTML = html;
        });

        // 用户中心渲染
        var center_model = document.getElementById('m_center').innerHTML;
        var center_view = document.getElementById('center');
        laytpl(center_model).render(user_info, function (html) {
            center_view.innerHTML = html;
        });
    });

</script>
</body>
</html>